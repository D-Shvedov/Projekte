<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GUN Todo Demo</title>
</head>

<body>
    <h1>Todo</h1>

    <p id="status"></p>

    <!-- Sign in/up -->
    <form id="sign">
        <input id="alias" placeholder="username" />
        <input id="pass" type="password" placeholder="passphrase" />
        <input id="in" type="submit" value="sign in" />
        <input id="up" type="button" value="sign up" />
    </form>

    <!-- App (hidden until login) -->
    <div id="app" style="display: none;">
        <h2>Profile</h2>

        <form id="profile">
            <input id="name" placeholder="name" />
            <input id="location" placeholder="location" />
            <input id="years" placeholder="years" />
            <input id="save" type="submit" value="save" />
        </form>

        <p id="publicKeyRow"><b>Public Key:</b> <span id="pubkey"></span></p>

        <h2>Messages</h2>
        <form id="said">
            <input id="say" placeholder="type message..." />
            <input id="speak" type="submit" value="speak" />
        </form>

        <ul id="messages"></ul>

        <button id="exit">Exit</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/gun/examples/jquery.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>

    <script>
        // Setup
        const gun = Gun([
            "http://localhost:8765/gun",
            "https://gun-manhattan.herokuapp.com/gun"
        ]);

        const user = gun.user();

        //  Help function
        function setStatus(text) {
            $("#status").text(text);
        }

        function showApp() {
            $("#sign").hide();
            $("#app").show();
        }

        function hideApp() {
            $("#app").hide();
            $("#sign").show();
        }

        function clearUI() {
            $("#messages").empty();
            $("#say").val("");
            $("#name").val("");
            $("#location").val("");
            $("#years").val("");
            $("#pubkey").text("");
        }

        // Render message (robust against object values)
        function renderMessage(data, id) {
            if (!data) return;

            const key = String(id);

            let line = "";
            if (typeof data === "object") {
                const n = (data.name || "").trim();
                const t = (data.text || "").trim();
                line = n ? (n + ": " + t) : t;   // wenn kein name -> nur text
            } else {
                line = String(data);
            }

            const $existing = $("#messages").find('[data-id="' + key + '"]');
            if ($existing.length) {
                $existing.text(line);
            } else {
                $("<li>").attr("data-id", key).text(line).appendTo("#messages");
            }
        }


        // Start listeners after successful login
        function startAfterLogin() {
            $("#messages").empty();

            // Live messages for this user only
            user.get("said").map().on(renderMessage);

            // Public key
            user.get("pub").once(function (pub) {
                $("#pubkey").text(pub || "");
            });

            // Load & decrypt profile
            user.get("private").get("profile").once(async function (enc) {
                if (!enc) return;
                const pass = $("#pass").val(); // demo: using passphrase from input
                const data = await SEA.decrypt(enc, pass);
                if (!data) return;

                $("#name").val(data.name || "");
                $("#location").val(data.location || "");
                $("#years").val(data.years || "");
            });
        }

        // --- Sign up ---
        $("#up").on("click", function (e) {
            e.preventDefault();

            const alias = $("#alias").val();
            const pass = $("#pass").val();
            if (!alias || !pass) {
                alert("Provide username and passphrase");
                return;
            }

            user.create(alias, pass, function (ack) {
                if (ack && ack.err) {
                    alert("Sign up failed: " + ack.err);
                    return;
                }
                // Auto login after create
                user.auth(alias, pass, function (ack2) {
                    if (ack2 && ack2.err) {
                        alert("Auto login failed: " + ack2.err);
                        return;
                    }
                    showApp();
                    startAfterLogin();
                });
            });
        });

        // --- Sign in ---
        $("#sign").on("submit", function (e) {
            e.preventDefault();

            const alias = $("#alias").val();
            const pass = $("#pass").val();
            if (!alias || !pass) {
                alert("Provide username and passphrase");
                return;
            }

            user.auth(alias, pass, function (ack) {
                if (ack && ack.err) {
                    alert("Login failed: " + ack.err);
                    return;
                }
                showApp();
                startAfterLogin();
            });
        });

        // --- Send message ---
        $("#said").on("submit", function (e) {
            e.preventDefault();

            const name = $("#name").val().trim()
            const text = $("#say").val().trim();
            if (!text) return;

            user.get("said").set({ name, text });
            $("#say").val("");
        });

        // --- Save profile (private) ---
        $("#profile").on("submit", async function (e) {
            e.preventDefault();
            if (!user.is) {
                alert("Not signed in");
                return;
            }

            const profile = {
                name: $("#name").val(),
                location: $("#location").val(),
                years: $("#years").val()
            };

            const pass = $("#pass").val(); // demo key
            const enc = await SEA.encrypt(profile, pass);
            user.get("private").get("profile").put(enc);

            alert("Profile saved (encrypted)");
        });

        // --- Exit ---
        $("#exit").on("click", function () {
            user.leave();
            clearUI();
            hideApp();
        });

        // --- Connection status ---
        gun.on("hi", function () {
            setStatus("connected");
        });

        // Optional: show something when disconnected (not always available depending on peer)
        gun.on("bye", function () {
            setStatus("disconnected");
        });
    </script>
</body>

</html>