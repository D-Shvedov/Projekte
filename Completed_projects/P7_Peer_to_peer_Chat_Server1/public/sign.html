<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>P2P Chat - Mirror</title>
    <link rel="stylesheet" href="p2p.css">
</head>

<body>
    <h1>P2P Chat - Mirror</h1>

    <p id="status"></p>
    <p id="peers"><b>Active Peers:</b> <span id="peerCount">0</span></p>

    <!-- Sign in/up -->
    <form id="sign">
        <input id="alias" placeholder="username" />
        <input id="pass" type="password" placeholder="passphrase" />
        <input id="in" type="submit" value="sign in" />
        <input id="up" type="button" value="sign up" />
    </form>

    <!-- App (hidden until login) -->
    <div id="app" style="display: none;">
        <h2>Profile</h2>

        <form id="profile">
            <input id="name" placeholder="name" />
            <input id="location" placeholder="location" />
            <input id="years" placeholder="years" />
            <input id="save" type="submit" value="save" />
        </form>

        <p id="publicKeyRow"><b>Public Key:</b> <span id="pubkey"></span></p>

        <h2>Messages</h2>
        <form id="said">
            <input id="say" placeholder="type message..." />
            <input id="speak" type="submit" value="speak" />
        </form>

        <ul id="messages"></ul>

        <button id="exit">Exit</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/gun/examples/jquery.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>

    <script>

        // Initialize Gun with a single peer (Server 1)
        const gun = Gun({
            peers: ["http://localhost:8765/gun"],
            localStorage: true
        });

        // Alternatively, connect to multiple relays
        // const gun = Gun([
        //     "http://localhost:8765/gun",
        //     "http://localhost:8766/gun"
        // ]);


        // User instance
        const user = gun.user();
        let messagesLoaded = false;

        // Define room and message node
        const room = "room:demo";
        const msgNode = gun.get("app").get(room).get("messages");

        // Debugging Gun messages
        gun.on("out", (msg) => {
            console.log("Gun message:", msg);
        });
        gun.on("in", (msg) => {
            console.log("IN:", msg);
        });


        // Monitor active peers
        setInterval(() => {
            const peers = Object.keys(gun._.opt.peers || {});
            $("#peerCount").text(peers.length);
            console.log("PEERS:", peers);
        }, 3000);



        //  Help function
        function setStatus(text) {
            $("#status").text(text);
        }

        function showApp() {
            $("#sign").hide();
            $("#app").show();
        }

        function hideApp() {
            $("#app").hide();
            $("#sign").show();
        }

        function clearUI() {
            $("#messages").empty();
            $("#say").val("");
            $("#name").val("");
            $("#location").val("");
            $("#years").val("");
            $("#pubkey").text("");
        }

        // Sign Up
        $("#up").on("click", () => {
            const alias = $("#alias").val();
            const pass = $("#pass").val();
            user.create(alias, pass, (ack) => {
                if (ack.err) {
                    setStatus("Error: " + ack.err);
                } else {
                    setStatus("Account created! Sign in now.");
                }
            });
        });

        // Sign In
        $("#in").on("click", (e) => {
            e.preventDefault();

            const alias = $("#alias").val();
            const pass = $("#pass").val();

            setStatus("Wait...");
            console.log("Attempting auth for user:", alias);

            user.auth(alias, pass, (ack) => {
                console.log("ACK:", ack);
                console.log("ack.err:", ack && ack.err);
                console.log("ack.ok:", ack && ack.ok);
                console.log("user.is:", user.is); // sehr wichtig

                if (ack && ack.err) {
                    setStatus("Error: " + ack.err);
                    console.error("Auth error:", ack.err);
                } else if (user.is) {
                    console.log("AUTH SUCCESS!");
                    setStatus("Logged in");
                    showApp();
                    displayPubKey();
                    loadProfile();
                    loadMessages();
                }
            });
        });

        // Auto re-authenticate if session exists
        user.recall({ sessionStorage: true });

        // On re-authentication
        gun.on("auth", () => {
            console.log("re-authenticated");
            setStatus("Logged in");
            showApp();
            displayPubKey();
            loadProfile();
            loadMessages();
        });

        // Detect page reload
        window.addEventListener("beforeunload", () => {
            console.warn(" PAGE RELOAD DETECTED");
        });


        // Save profile
        $("#save").on("click", (e) => {
            e.preventDefault();
            user.get("profile").put({
                name: $("#name").val(),
                location: $("#location").val(),
                years: $("#years").val()
            });
            setStatus("Profile saved!");
        });

        // Load profile
        function loadProfile() {
            user.get("profile").on((profile) => {
                if (profile) {
                    $("#name").val(profile.name || "");
                    $("#location").val(profile.location || "");
                    $("#years").val(profile.years || "");
                }
            });
        }

        // Get public key
        function displayPubKey() {
            user.get("pub").once((pub) => {
                $("#pubkey").text(pub);
            });
        }

        // Send message
        $("#said").on("submit", (e) => {
            e.preventDefault();
            const message = $("#say").val().trim();
            if (!message) return;

            msgNode.set({
                text: message,
                name: $("#name").val() || user.is?.alias || "anon",
                pub: user.is?.pub,
                at: Date.now()
            });

            $("#say").val("");
        });

        // Render message (robust against object values)
        function renderMessage(data, id) {
            if (!data) return;

            const line = typeof data === "object"
                ? ((data.name ? data.name + ": " : "") + (data.text || "") + (data.at ? " (" + new Date(data.at).toLocaleTimeString() + ")" : "")).trim()
                : String(data).trim();

            if (!line) return;

            let li = $(`#messages li[data-id="${id}"]`);
            if (!li.length) {
                li = $("<li>").attr("data-id", id).prependTo("#messages");
            }
            li.text(line);
        }

        // Load messages
        function loadMessages() {
            if (messagesLoaded) return;
            messagesLoaded = true;

            msgNode.map().on((data, id) => {
                if (!id || id === "_" || !data || !data.text) return;
                console.log("RECV", id, data);
                renderMessage(data, id);
            });

        }

        // Exit
        $("#exit").on("click", () => {
            user.leave();
            clearUI();
            hideApp();
            setStatus("Logged out");
        });

        // Initial status
        loadMessages();
        setStatus("ready");

    </script>
</body>

</html>